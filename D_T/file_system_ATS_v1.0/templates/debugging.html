<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="icon" href="../images/icon.svg" />
    <link href="../static/static.css" rel="stylesheet"/>
    <title>Отладка</title>
</head>
<body>
    <div class="wrapper">
        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
                <span></span>
            </label>
            <ul class="menu__box">
                <div class="block_status">
                    <div class="block_icon_status">
                        <a href="access-point.html"><img class="icon_status" src="../images/access-point.svg" title="Точка доступа" alt=""></a>
                    </div>
                    <div class="block_icon_status">
                        <a href="wi-fi.html"><img class="icon_status" src="../images/wi-fi.svg" title="Wi-FI" alt=""></a>
                    </div>
                    <div class="block_icon_status">
                        <a href="ethernet.html"><img class="icon_status" src="../images/ethernet.svg" title="Ethernet" alt=""></a>
                    </div>
                </div>
                <li><img class="icon_settings" src="../images/home.svg" alt=""><a href="../index.html" class="title_menu">Главная</a></li>
                <li><img class="icon_settings" src="../images/settings.svg" alt=""><a href="settings.html" class="title_menu">Настройки</a></li>
            </ul>
        </div>
        <div class="container_menu">
            <div class="block_menu">
                <div class="point_menu">
                    <a href="../index.html"><img class="icon_settings" src="../images/home.svg" alt=""></a>
                    <a href="../index.html" class="title_menu_main">Главная</a>
                </div>
                <div class="point_menu">
                    <a href="settings.html"><img class="icon_settings" src="../images/settings.svg" alt=""></a>
                    <a href="settings.html" class="title_menu_main">Настройки</a>
                </div>
            </div>
        </div>
        <div class="container_settings">
            <div class="header_body">
                <div class="header_logo">
                    <img class="logo" src="../images/logo_w.svg" alt="">
                </div>
            </div>
            <div class="block_fixed">
                <div class="block_status_main">
                    <div class="block_icon_status">
                        <div class="tooltip_status"><a href="access-point.html"><img class="icon_status" src="../images/access-point.svg" alt=""></a>
                            <span class="tooltiptext_status"><span id="ip_conn_ap" style="color: rgb(112, 112, 150);">-</span></span>
                        </div>
                    </div>
                    <div class="block_icon_status">
                        <div class="tooltip_status"><a href="wi-fi.html"><img class="icon_status" src="../images/wi-fi.svg" title="Wi-FI" alt=""></a>
                            <span class="tooltiptext_status"><span id="ip_conn_wifi" style="color: rgb(112, 112, 150);">-</span></span>
                        </div>
                    </div>
                    <div class="block_icon_status">
                        <div class="tooltip_status"><a href="ethernet.html"><img class="icon_status" src="../images/ethernet.svg" title="Ethernet" alt=""></a>
                            <span class="tooltiptext_status"><span id="ip_conn_eth" style="color: rgb(112, 112, 150);">-</span></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="body_go_back_button">
                <a href="javascript: history.go(-1)">
                    <img class="icon_settings" src="../images/go_back.svg" alt="">
                    <a class="go_back_button" href="javascript: history.go(-1)">Назад</a>
                </a>
            </div>
            <div class="container">
                <div class="block_settings_title">
                    <div class="line_settings">
                        <a class="main_title_text">Отладка</a>
                    </div>
                </div>
                <div class="seporator_full"></div>
                <div class="block_settings_form top_block">
                    <form id="settings_form">
                        <div class="block_main_serv_">
                            <label for="serv" class="label_serv wrapper_3015">Сервис</label>
                            <div class="block_main_serv">
                                <div class="crypto_ui_3-select wrapper_3015">
                                    <select name="serv" id="serv">
                                        <option>-- Выберите сервис --</option>
                                        <option id="/api/getData.api">/api/getData.api</option>
                                        <option id="/api/getHex.api">/api/getHex.api</option>
                                        <option id="/api/getStrData.api?inv=1">/api/getStrData.api?inv=1</option>
                                        <option id="/api/getStrData.api?inv=0">/api/getStrData.api?inv=0</option>
                                    </select>
                                    <div class="crypto_ui_3-select_arrow"></div>
                                </div>
                                <div class="block_main_serv">
                                    <input type="text" id="add_request" class="save wrapper_3015" placeholder="Дополнительный запрос" name="add_request">
                                    <a href="#" id="clear_x"></a>
                                </div>
                            </div>
                        </div>
                        <div class="block_main_serv_">
                            <div class="wrapper_3015" style="margin-top: 10px; margin-bottom: 10px;">
                                <input type="checkbox" class="auto_update checkbox_right" id="auto_update" name="auto_update"/>
                                <label class="checkbox" for="auto_update">Автообновление</label>
                            </div>
                            <label for="period_serv" class="wrapper_3015" style="width: 85px;">Период, мс</label>
                            <span id="raz_s" class="wrapper_3015">
                                <input type="number" id="period_serv" class="period_serv save" placeholder="0" name="period_serv" min="0" step="100">
                                <span onclick="this.previousElementSibling.stepUp()"></span>
                                <span onclick="this.previousElementSibling.previousElementSibling.stepDown()"></span>
                            </span>
                            <div class="wrapper_3015" style="margin-top: 10px; margin-bottom: 10px;">
                                <input type="checkbox" class="auto_clear checkbox_right" id="auto_clear" name="auto_clear"/>
                                <label class="checkbox" for="auto_clear">Авто очистка</label>
                            </div>
                        </div>
                        <div class="block_clear">
                            <div class="block_main_serv">
                                <div class="block_serv">
                                    <a class="wrapper_button" id="button_serv">Старт</a>
                                    <a class="wrapper_button" id="button_serv_stop" style="display: none;">Стоп</a>
                                </div>
                            </div>
                            <div class="block_main_serv">
                                <a class="wrapper_button" id="button_serv_clear">Очистить</a>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: center;">
                            <pre class="textarea_res" id="log"></pre>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        const PATH_FOR_GETDATA = "/api/getData.api";
const PATH_FOR_GETHEX = "/api/getHex.api";
const PATH_FOR_GETSTRDATA_1 = "/api/getStrData.api?inv=1";
const PATH_FOR_GETSTRDATA_0 = "/api/getStrData.api?inv=0";

function docReady(fn) {
    if (document.readyState === "complete" || document.readyState === "interactive") {
        setTimeout(fn, 1);
    } else {
        document.addEventListener("DOMContentLoaded", fn);
    }
};

function getJSONfromDevice(url, callback){
	var xhr = new XMLHttpRequest();
	xhr.open('GET', url, true);
	xhr.responseType = 'json';
	xhr.onload = function() {
		var status = xhr.status;
		if (status === 200) {
			callback(null, xhr.response);
		} else {
			callback(status, xhr.response);
		}
	};
	xhr.send();
};

function CallBackFunction(err, url){
    if(err){
        //Error!
    }else{
        (function () {
            var old = console.log;
            var logger = document.getElementById('log');
            console.log = function (message) {
                if (typeof message == 'object') {
                    logger.innerHTML += (JSON && JSON.stringify ? JSON.stringify(message, null, 4) : message) + '<br />';
                } else {
                    logger.innerHTML += message + '<br />';
                }
            }
        })();
        
        console.log(url);
    }
};

function clearInput(){
    let add_request = document.getElementById('add_request');
    let req = "";

    if(add_request.value == ""){
        //;
    } else {
        req = "/" + add_request.value;
    }

    return req;
};

function clearInter(x){
    clearInterval(x);
}

function clearConsole(){
    var logger = document.getElementById('log');
    logger.innerHTML = "";
}
/*
let inp = document.querySelectorAll('.save'),
	vals = localStorage.getItem('vals') ? localStorage.getItem('vals').split`,` : '';

for(let i = 0; i < inp.length; i++) vals[i] ? inp[i].value = vals[i] : '';
window.addEventListener('beforeunload',() => localStorage.setItem('vals', [...inp].map(e => e.value)) );
*/
docReady(function(){
    document.getElementById('button_serv').onclick = function() {
        let serv = document.getElementById("serv");
        let desiredBox = serv.options[serv.selectedIndex].value;
        let auto_update = document.getElementById('auto_update');
        let period_serv = document.getElementById('period_serv').value;
        let auto_clear = document.getElementById('auto_clear');
    
        let url;
    
        if(desiredBox == "-- Выберите сервис --"){
            url = clearInput();
        } else if(desiredBox == "/api/getData.api"){
            url = PATH_FOR_GETDATA + clearInput();
        } else if(desiredBox == "/api/getHex.api"){
            url = PATH_FOR_GETHEX + clearInput();
        } else if(desiredBox == "/api/getStrData.api?inv=1"){
            url = PATH_FOR_GETSTRDATA_1 + clearInput();
        } else if(desiredBox == "/api/getStrData.api?inv=0"){
            url = PATH_FOR_GETSTRDATA_0 + clearInput();
        }

        let reloadF;
    
        if(auto_update.checked && period_serv !== "" && !auto_clear.checked){
            document.getElementById("button_serv").style.display = "none";
            document.getElementById("button_serv_stop").style.display = "block";
            getJSONfromDevice(url, CallBackFunction);
            reloadF = setInterval(() => {
                getJSONfromDevice(url, CallBackFunction);
            }, period_serv);
        } else if(auto_update.checked && period_serv !== "" && auto_clear.checked){
            document.getElementById("button_serv").style.display = "none";
            document.getElementById("button_serv_stop").style.display = "block";
            getJSONfromDevice(url, CallBackFunction);
            reloadF = setInterval(() => {
                clearConsole();
                getJSONfromDevice(url, CallBackFunction);
            }, period_serv);
        } else {
            getJSONfromDevice(url, CallBackFunction);
        }

        document.getElementById('button_serv_stop').onclick = function(){
            clearInter(reloadF);
            document.getElementById("button_serv_stop").style.display = "none";
            document.getElementById("button_serv").style.display = "block";
        }
    }
    
    document.getElementById('button_serv_clear').onclick = function(){
        clearConsole();
    }
});

// очищает поле доп. запрос
document.getElementById("clear_x").onclick = function(e) {
    document.getElementById("add_request").value = "";
}

    </script>
</body>